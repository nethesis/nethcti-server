<!doctype html>
<html>
  <head>
    <title>CTI Nethesis 0.1</title>
    <script src="/json.js"></script> <!-- for ie -->
    <script src="/lib/socket.io-client/socket.io.js"></script>
<!-- distribution version: more efficient and smaller
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
-->
    <script src="jquery-1.5.1.js"></script>
    <script src="content_script.js"></script>
	<script src="updategui.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.js'></script>

  </head>
  <body onload='window.webkitNotifications.requestPermission();'>

	<script>
		bg = '';
    	var slideDelay = 200;	
    </script>
    
    
    
	<div id='info_notification' style='display:none'>
      	<p>Click on "Enable notifications" only the first time you access this page.</p>
      	<input type='button' id='enable' value='Enable notifications'/>    
    </div>
    
    <div id='logout_div' style='display:none'>
    	<input type='button' id='logout' value='Logout'/>
    </div>
    
    <div id='login_div'>
	    <h3>Login:</h3>
    	<label for='ext' >Extension:</label><input type='text' name='ext' id='ext' value='500'/>
	    <label for='secret' >Secret:</label><input type='text' name='secret' id='secret' value='500'/>      
	    <input type='button' id='login' value='Login'/>   
	    <label id='info_login'></label>
	    <br/>
	</div>
    
    
    <div id='dialout_div' style='display:none'>
		<hr/><br/>
		<h3>Dial panel</h3>
		<div id='call_out_div'>
			<label for='extToCall' >Call to:    </label><input type='text' name='extToCall' id='extToCall' value='501'/>      
		
			<input type='button' id='call' value='Call'/>
			<br/>
		</div>
		<label id='info_calling'></label>
		<br/><br/>
		<div id='buttoncall' style='display:none'>
			<input type='button' id='hangup' value='Hangup'/>
			<input type='button' id='waiting' value='Waiting' disabled='true'/>
			<input type='button' id='record' value='Record' disabled='true'/><br/>
			<label>Redirect to: </label><input type='text' id='redirect_to'/><input type='button' id='redirect' value='Redirect' disabled='true'/>
			
		</div>
		<br/>
	</div>
	
	
	<div id="address" style='display:none'>
		<br/><hr/>
		<h3>Address book</h3>	
		<label>Search:  </label><input type="text" id="searchcontact" name="searchcontact"/>
		<br/><br/>
		<div id="searchContacts">
		</div> 
	</div>
	<div id="resultsContainer"></div>
	





    <script>
    
    	$(function(){
    	
    		if (window.webkitNotifications) {
				console.log("Notifications are supported!");
			}
			else {
				var msg = "Notifications are not supported for this Browser/OS version yet.";
				console.log(msg);
				return;
			}
    	
    	
    		if (window.webkitNotifications.checkPermission() == 0) { // 0 is PERMISSION_ALLOWED
		    	// function defined in step 2
			    console.log("Notification allowed");
			} else {
				console.log("Notification NOT allowed");
				$('#info_notification').slideDown(slideDelay);
			}
			
			if(localStorage.getItem('user')!=null && localStorage.getItem('user')!=undefined){
				updateAckLoginGui();
			}
			
			bg = chrome.extension.getBackgroundPage();
			if(bg){
				console.log("ok background is present");
			} else{
				console.log("Error: background is null");
			}
			
		});
		
		
		$('#enable').click(function() {
			window.webkitNotifications.requestPermission(function(){
				$('#info_notification').slideUp(slideDelay);
			});	
		});


		$('#login').click(function(){
			console.log("click login");
			
			var user = localStorage.getItem('user');
			if(user!=null && user!='undefined'){
				//updateAckLoginGui();
				console.log('You are already logged in !');
  				return;
		  	}
		  	
			var extFrom = document.querySelector('#ext').value;
		    var secret =  document.querySelector('#secret').value;
		  	console.log("ok invio richiesta di login al background");
		    bg.doLogin({ extFrom: extFrom, secret: secret, action: "login" });
		    console.log("richiesta di login al background inviata");

		});

		$('#call').click(function(){

		    var extFrom = localStorage.getItem('user');
    		var extToCall =  $('#extToCall').val();
    		
    		if(extFrom==extToCall){    		
    			$('#info_calling').slideDown(slideDelay);
    			$('#info_calling').text('Attention: you trying to call yourself !');
    			return;
    		}
    		
    		bg.doCall({ extToCall: extToCall, extFrom: extFrom, action: "call_out_from_client" });
    		
			$('#info_calling').slideDown(slideDelay);
		    $('#info_calling').text('Calling...');
		    document.getElementById('call').value = 'Calling...';
		    $('#call').attr('disabled', true);
		    $('#buttoncall').slideDown(slideDelay);
		    $('#login_div').slideUp(slideDelay);
		    $('#address').slideUp(slideDelay);
		});
		
		$('#hangup').click(function(){
			var extFrom = localStorage.getItem('user');
			bg.doHangup({ extFrom: extFrom, action: "hangup" });
		});
		
		$('#logout').click(function(){
			var extFrom =  localStorage.getItem('user');
			bg.doLogout({ extFrom: extFrom, action: "logout" });
		});
		
		$('#waiting').click(function(){
			console.log("to implement");
		},false);
		
		
		$('#redirect').click(function(){
	
			var extFrom = localStorage.getItem('user');
			var redirectTo = $('#redirect_to').val();
		
			bg.doRedirect({extFrom: extFrom, redirectTo: redirectTo, action: 'redirect'});
   			$('#redirect').attr('enabled',false);
		},false);
		
		// live search of phonebook contacts
		$(document).ready(function() {
			$("#searchcontact").keyup(function(){
				var extFrom = localStorage.getItem('user');
				var namex = $("#searchcontact").val();
				if(namex.length>=2){
					bg.doSearchContact({extFrom: extFrom, namex: namex, action: 'search_contact_phonebook'});
				}
			});
		});
		
		$('#record').click(function(){
		
			var buttonValue = $('#record').val();
			var extFrom = localStorage.getItem('user');
			
			if(buttonValue == 'Record'){
				bg.doStartRecord({ extFrom: extFrom, action: 'record' });
			}
			else{ // stop recording
				bg.doStopRecord({ extFrom: extFrom, action: 'stoprecord' });
			}	
		});


		// This is function is for clicck to call on result of searching contacts on phonebook
		callExt = function(extToCall){
		
			var extFrom = localStorage.getItem('user');
			
    		if(extFrom==extToCall){
	    		$('#info_calling').slideDown(slideDelay);
    			document.getElementById('info_calling').innerHTML = 'Attention: you trying to call yourself !';
    			return;
    		}
    		
    		bg.doCall({ extToCall: extToCall, extFrom: extFrom, action: "call_out_from_client" });
    		
		    $('#info_calling').text('Calling...');
		    document.getElementById('call').value = 'Calling...';
		    $('#call').attr('disabled', true);
		    $('#info_calling').slideDown(slideDelay);
		    $('#buttoncall').slideDown(slideDelay);
		    $('#login_div').slideUp(slideDelay);
			$('#address').slideUp(slideDelay, function(){
				$('#searchContacts').empty();
	      		$('#searchcontact').val('');
			});	
		}

		
    </script> 
    
    
    
  </body>
</html>
