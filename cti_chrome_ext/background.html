<html>
<head>
	<script src="/json.js"></script> 
    <script src="/lib/socket.io-client/socket.io.js"></script>
    <script src="jquery-1.5.1.js"></script>
	<script src="back_function.js"></script>
</head>
<body>
	
	<script>
		callFromExt = '';
		callToExt = '';
		notificationTimeout = 5000;
		proxy_address = "amaduzzi";
		proxy_port = 8080;
		INDEX_NAME = "indexcti.html";
	</script>
	
	<script>

		chrome.windows.onCreated.addListener(function(win) {

			var update = true;
			chrome.windows.getAll({"populate": true}, function(arwins){
				/*
				for(var i=0; i<arwins.length; i++){
					var win = arwins[i];
					console.log("win.id = " + win.id);
					var artabs = win.tabs;
					for(var x=0; x<artabs.length; x++){
						var tab = artabs[x];
						console.log("tab.url = " + tab.url);
						if(isCtiUrl(tab.url)){
							update = false;
						}
					}
				}*/
				if(arwins.length>1)
					update=false;
				console.log("UPDATE = " + update);
				if(update){
					chrome.tabs.getAllInWindow(win.id, function(tabs){
						for(var i=0, tab; tab=tabs[i]; i++){
							console.log("[" + i + "]: tab.url = " + tab.url);
							if(tab.url && isCtiUrl(tab.url) && ((i+1) <tabs.length ) ){
								console.log("[[[[[[[ remove tab.url = " + tab.url + " " + tab.id);
								chrome.tabs.remove(tab.id);
							}
						}
						//console.log("3 sono entrato");
						//console.log("[[[[[[[ tab create");
		            	//chrome.tabs.create({url:INDEX_NAME}); 
	            	});
	            }
				
			});   
        });	
                

		window.addEventListener("load", init, false);
		
		
		
		
	
	
	
		function init(){
			
			socket = new io.Socket(proxy_address, {port: 8080, rememberTransport: false});
	      	socket.connect();
	      	
	      	socket.on('message', function(obj){
      	
    	  		console.debug("Received message: ");
		      	console.log(obj);
        
		    	switch(obj.typeMessage){
		    		case 'connected': 

		    		break;
					case 'error_login': 
						
					break;
					case 'ack_login':
					    if(localStorage.getItem('user')==null || localStorage.getItem('user')=='undefined'){
						    localStorage.setItem('user', obj.ext);
						    localStorage.setItem('password', obj.secret);
						}
						callFromExt = '';
		      			callToExt = '';
						
		    		break;
		    		case 'error_call':
		    			
		    		break;
		    		case 'dialing':
		    			
			    		htmlDesktopNotification(obj);
			    		console.log(obj);
			      		callFromExt = obj.from;
			      		callToExt = localStorage.getItem('user');

		    		break;
		    		case 'callconnected': 

		    		break;
		    		case 'hangup': 
		    			callFromExt = '';
		      			callToExt = '';

		    		break;
		    		case 'error_redirect':

		    		break;
		    		case 'ack_redirect': 

		    		break;
		    		case 'error_search_contacts': 

		    		break;
		    		case 'search_contacts_results': 

		    		break;
		    		case 'error_record': 

		    		break;
		    		case 'ack_record': 

		    		break;
		    		case 'ack_stoprecord':
		    			
		    		break;
		    		case 'ack_logout': 
		    			localStorage.removeItem('user');
						localStorage.removeItem('password');
		    			
		    		break;
		    		default:
						
		    		break;    		
		    	}

				chrome.extension.sendRequest(obj);
		   	});
    	

    		// if the user and password are set, then it do the login action
    		var user = localStorage.getItem('user');
			if(user!=null && user!='undefined'){
				var extFrom = localStorage.getItem('user');
			   	var secret = localStorage.getItem('password');
				socket.send({ extFrom: extFrom, secret: secret, action: "login" });
				console.log("sended login request from: " + extFrom);
			}
			
			
			
			
			
			chrome.browserAction.onClicked.addListener(function(tab){

				chrome.tabs.getAllInWindow(null, function(tabs){
					for(var i=0, tab; tab=tabs[i]; i++){
						if(tab.url && isCtiUrl(tab.url)){
							console.log("YYYYYYY hai clicczato per UPDATE tab.url = " + tab.url);
							chrome.tabs.update(tab.id, {selected: true});
							return;
						}
					}
					console.log("YYYYYYY hai clicczato per CREATE url = " + INDEX_NAME);
					chrome.tabs.create({url: INDEX_NAME});
				});
			});
		}
		
		function isCtiUrl(url){
			var one = url.indexOf(INDEX_NAME) != -1 ? true : false;
			var two = url.indexOf("chrome-extension://") != -1 ? true : false;
			return one && two;
		}
	
		
		
		
	</script>
</body>
</html>
