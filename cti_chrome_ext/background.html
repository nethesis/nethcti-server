<html>
<head>
	<script src="/json.js"></script> 
    <script src="/lib/socket.io-client/socket.io.js"></script>
    <script src="jquery-1.5.1.js"></script>
	<script src="back_function.js"></script>
</head>
<body>
	
	<script>
		callFromExt = '';
		callToExt = '';
		notificationTimeout = 5000;
		proxy_address = "amaduzzi";
		proxy_port = 8080;
		INDEX_NAME = "indexcti.html";
	</script>
	
	<script>

		chrome.windows.onCreated.addListener(function(win) {
					
			var update = true;
			chrome.windows.getAll({"populate": true}, function(arwins){
			
				if(arwins.length>1)
					update=false;
				if(update){
					chrome.tabs.getAllInWindow(win.id, function(tabs){
						for(var i=0, tab; tab=tabs[i]; i++){
							if(tab.url && isCtiUrl(tab.url) && ((i+1) <tabs.length ) ){
								chrome.tabs.remove(tab.id);
							}
						}
	            	});
	            }				
			});   
        });	
                

		window.addEventListener("load", init, false);
		
		
	
		function init(){
			
			socket = new io.Socket(proxy_address, {port: 8080, rememberTransport: false});
	      	socket.connect();
	      	
	      	socket.on('message', function(obj){
      	
    	  		console.debug("Received message: ");
		      	console.log(obj);
        
		    	switch(obj.typeMessage){
		    		case 'connected': 

		    		break;
					case 'error_login': 
						
					break;
					case 'ack_login':
					    if(localStorage.getItem('user')==null || localStorage.getItem('user')=='undefined'){
						    localStorage.setItem('user', obj.ext);
						    localStorage.setItem('password', obj.secret);
						}
						callFromExt = '';
		      			callToExt = '';
						
		    		break;
		    		case 'error_call':
		    			
		    		break;
		    		case 'dialing':
		    			
			    		htmlDesktopNotification(obj);
			      		callFromExt = obj.from;
			      		callToExt = localStorage.getItem('user');

		    		break;
		    		case 'callconnected': 

		    		break;
		    		case 'hangup': 
		    			callFromExt = '';
		      			callToExt = '';

		    		break;
		    		case 'error_redirect':

		    		break;
		    		case 'ack_redirect': 

		    		break;
		    		case 'error_search_contacts': 

		    		break;
		    		case 'search_contacts_results': 

		    		break;
		    		case 'error_record': 

		    		break;
		    		case 'ack_record': 

		    		break;
		    		case 'ack_stoprecord':
		    			
		    		break;
		    		case 'ack_logout': 
		    			localStorage.removeItem('user');
						localStorage.removeItem('password');
		    			
		    		break;
		    		default:
						
		    		break;    		
		    	}

				chrome.extension.sendRequest(obj);
		   	});
    	

    		// if the user and password are set, then it do the login action
    		var user = localStorage.getItem('user');
			if(user!=null && user!='undefined'){
				var extFrom = localStorage.getItem('user');
			   	var secret = localStorage.getItem('password');
				socket.send({ extFrom: extFrom, secret: secret, action: "login" });
				console.log("sended login request from: " + extFrom);
			}
		}
		
		
		
		chrome.browserAction.onClicked.addListener(function(tab){
			
			chrome.tabs.getAllInWindow(null, function(tabs){
			
				for(var i=0, tab; tab=tabs[i]; i++){
					if(tab.url && isCtiUrl(tab.url)){
						chrome.tabs.update(tab.id, {selected: true});
						return;
					}
				}
				chrome.tabs.create({url: INDEX_NAME});
				return;
			});
		});
		
		function isCtiUrl(url){
			var one = url.indexOf(INDEX_NAME) != -1 ? true : false;
			var two = url.indexOf("chrome-extension://") != -1 ? true : false;
			return one && two;
		}
	
		
		
		
	</script>
</body>
</html>
