<!doctype html>
<html>
  <head>
    <title>CTI Nethesis 0.1</title>
    <script src="/json.js"></script> <!-- for ie -->
    <script src="/lib/socket.io-client/socket.io.js"></script>
    <script src="jquery-1.5.1.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.js'></script>

  </head>
  <body>

	<script>
		callFromExt = '';
		callToExt = '';
	</script>

    <script>
    	var notificationTimeout = 5000;
    	var slideDelay = 200;
    	var outcall = false;

	    function normalDesktopNotification(obj){
    
    	    if (window.webkitNotifications) { //enable notification if supported
	            notification = window.webkitNotifications.createNotification("",esc(obj.clientSessionId),esc(obj.respMessage));
	            notification.ondisplay = function() { console.log("Display notification"); };
	            notification.onclose = function() { console.log("Close notification"); };
	            notification.onclick = function() { 
	            	window.focus(); 
	            	this.cancel(); 
	            };
	            notification.show();
    	        
	            /*
	            setTimeout(function(){
					notification.cancel();
				}, notificationTimeout);
				*/
	      	}
	    }
      
      
      	
      	function htmlDesktopNotification(socket, respMessage){
            	
    		var host = socket.host;
    		var port = socket.options["port"];
    	
        	if (window.webkitNotifications) { //enable notification if supported
			
				var reqUrl = "./getNotificationCalling.html?server=" + host + "&port=" + port + "&from=" + respMessage.from + "&to=" + respMessage.to + "&respMessage=" + respMessage.respMessage;
            	notification = window.webkitNotifications.createHTMLNotification(reqUrl);
	            notification.ondisplay = function() { console.log("Display notification"); };
	            notification.onclose = function() { console.log("Close notification"); };
	            notification.show(); // note the show()
            
	            /*
            	setTimeout(function(){
					notification.cancel();
				}, notificationTimeout);
				*/
        	}
      	}
      

      	function esc(msg){
        	return msg.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      	};
      
  
    
      	var socket = new io.Socket(null, {port: 8080, rememberTransport: false});
      	socket.connect();
      	socket.on('message', function(obj){
      	
      		console.debug("Received msg: ");
	      	console.log(obj);
      	
      		if(obj.typeMessage=="dialing"){
	      		console.log("dialing: HTML notification");
	      		htmlDesktopNotification(socket, obj);
	      		
				$('#call_out_div').slideUp(slideDelay);
				$('#buttoncall').slideDown(slideDelay);
				$('#logged_in_div').slideUp(slideDelay);
				$('#address').slideUp(slideDelay);
	      		document.getElementById('info_calling').innerText = 'Call incoming from ' + obj.from;
	      		callFromExt = obj.from;
	      		callToExt = localStorage.getItem('user');
	      	}
      		else if(obj.typeMessage!="search_contacts_results" && obj.typeMessage!="ack_login"){
		      	console.log("normal notification");
		      	normalDesktopNotification(obj);
		    }
	    
	    	switch(obj.typeMessage){
	    		case 'callconnected':
	    			console.log(obj.respMessage);
		      		document.getElementById('info_calling').innerText = obj.respMessage;
		      		document.getElementById('call').value = 'Calling...';
				    document.getElementById('call').disabled = 'true';
				    document.getElementById('redirect').disabled = false;
	    		break;
	    		case 'hangup':
	    			console.log(obj.respMessage);
		      		document.getElementById('info_calling').innerText = obj.respMessage;      		
		      		$('#call_out_div').slideDown(slideDelay);
		      		$('#buttoncall').slideUp(slideDelay);
		      		$('#logged_in_div').slideDown(slideDelay);
		      		$('#address').slideDown(slideDelay);
		      		document.getElementById('call').value = 'Call';
		      		document.getElementById('call').disabled = false;
		      		callFromExt = '';
	      			callToExt = '';
	    		break;
	    		case 'search_contacts_results':
	    			var results = obj.results;
	      			if($('#searchContactsResults')!=undefined){
		      			$('#searchContactsResults').remove();
		      		}
	      		
		      		var htmlResults = "<div id='searchContactsResults'>";

		      		for(var i=0; i<results.length; i++){
		      			var el = results[i];
		      			for(key in el){
		      			
		      				if(key=='workphone'){
		      					console.log("uguale workphone");
		      					var call = "callExt(" + el[key] + ");";
		      					htmlResults += key + ':  <b>' + el[key] + '  </b><input type="button" onclick=' + call + ' value="Call"/><br/>';
		      				}
		      				else{      				
				      			htmlResults += key + ':  <b>' + el[key] + '</b><br/>';
				      		}
			      		}
			      		htmlResults += '<br/>';
		      		}
		      		htmlResults += '<div/>';
		      		
		      		$('#searchContacts').append(htmlResults);
	    		break;
	    		case 'ack_login':
	    			var extFrom =  document.querySelector('#ext').value;
				    var secret =  document.querySelector('#secret').value;
				    if(localStorage.getItem('user')==null){
					    localStorage.setItem('user', extFrom);
					    localStorage.setItem('password', secret);
					}
				    console.log('user = ' + localStorage.getItem('user'));
				    console.log('password = ' + localStorage.getItem('password'));
				    
				    $('#login_div').slideUp(0);
				    $('#info_notification').slideUp(0);
				    $('#logged_in_div').slideDown(slideDelay);
				    $('#logout').slideDown(slideDelay);
				    document.getElementById('logout').value = 'Logout ' + extFrom;
				    $('#dialout_div').slideDown(slideDelay);
				    $('#address').slideDown(slideDelay);
				    $('#dialout_div').slideDown(slideDelay);
				    callFromExt = '';
	      			callToExt = '';
	    		break;
	    		default:
	    			console.log("default operation");
	    		break;    		
	    	}
	   });
      
   


		if (window.webkitNotifications) {
			console.log("Notifications are supported!");
		}
		else {
			console.log("Notifications are not supported for this Browser/OS version yet.");
		}

    </script>
    
    
    
	<div id='info_notification' style='font-size: 80%; margin: 20px; '>
   		<h2>CTI Nethesis</h2>
      	<p>Click on "Enable notifications" only the first time you access this page.</p>
      	<input type='button' id='enable' value='Enable notifications'/>    
    </div>
    
    <div id='logged_in_div'>
    	<!--<h5 id='str_logged_in'>Not logged in</h5>-->
    	<input type='button' id='logout' value='Logout' style='display:none'/>
    </div>
    
    <div id='login_div'>
	    <h3>Login:</h3>
    	<label for='ext' >Extension:</label><input type='text' name='ext' id='ext' value='500'/>
	    <label for='secret' >Secret:</label><input type='text' name='secret' id='secret' value='500'/>      
	    <input type='button' id='login' value='Login'/>   
	    <br/>
	</div>
    
    
    <div id='dialout_div' style='display:block'>
		<hr/><br/>
		<h3>Dial panel</h3>
		<div id='call_out_div'>
			<label for='extToCall' >Call to:    </label><input type='text' name='extToCall' id='extToCall' value='501'/>      
		
			<input type='button' id='call' value='Call'/>
			<br/>
		</div>
		<label id='info_calling'></label>
		<br/><br/>
		<div id='buttoncall' style='display:block'>
			<input type='button' id='hangup' value='Hangup'/>
			<input type='button' id='waiting' value='Waiting' disabled='true'/><br/>
			<label>Redirect to: </label><input type='text' id='redirect_to'/><input type='button' id='redirect' value='Redirect' disabled='true'/>
			
		</div>
		<br/>
	</div>
	
	
	<div id="address" style='display:none'>
		<br/><hr/>
		<h3>Address book</h3>	
		<label>Search:  </label><input type="text" id="searchbox" name="searchbox"/>
		<br/><br/>
		<div id="searchContacts">
		</div> 
		
		<label>Search:  </label><input id="tags"/>
	</div>
	<div id="resultsContainer"></div>
	
    <script>
    
    
    	// if the user and password are set, then it do the login action
		if(localStorage.getItem('user')!=null){
			var extFrom = localStorage.getItem('user');
	    	var secret = localStorage.getItem('password');
			socket.send({ extFrom: extFrom, secret: secret, action: "login" });
			console.log("sended login request from: " + extFrom);
		}
    	
   		
   
		document.querySelector('#enable').addEventListener('click', function() {
			if (window.webkitNotifications.checkPermission() == 0) { // 0 is PERMISSION_ALLOWED
		    	// function defined in step 2
			    console.log("Notification allowed");
			} else {
			    console.log("Notification NOT allowed");
			    window.webkitNotifications.requestPermission();
			}
		},false);



		document.querySelector('#login').addEventListener('click', function() {
  			if(localStorage.getItem('user')!=null){
				console.log('Sorry, but you are already logged in !');
  				return;
		  	}
			var extFrom =  document.querySelector('#ext').value;
		    var secret =  document.querySelector('#secret').value;
			socket.send({ extFrom: extFrom, secret: secret, action: "login" });
			console.log("sended login request from: " + extFrom);
		},false);

		document.querySelector('#call').addEventListener('click', function() {

		    var extFrom = localStorage.getItem('user');
    		var extToCall =  document.querySelector('#extToCall').value;
    		
			callFromExt = extFrom;
			callToExt = extToCall;
			
			console.log('callFromExt = ' + callFromExt);
    		
    		if(extFrom==extToCall){
    		
    			$('#info_calling').slideDown(slideDelay);
    			document.getElementById('info_calling').innerHTML = 'Attention: you trying to call yourself !';
    			return;
    		}
		    socket.send({ extToCall: extToCall, extFrom: extFrom, action: "call_out_from_client" });
		    console.log("sended call request from " + extFrom + " -> to " + extToCall);

			$('#info_calling').slideDown(slideDelay);
		    document.getElementById('info_calling').innerText = 'Calling...';
		    document.getElementById('call').value = 'Calling...';
		    document.getElementById('call').disabled = 'true';
		    $('#buttoncall').slideDown(slideDelay);
		    $('#logged_in_div').slideUp(slideDelay);
		    $('#address').slideUp(slideDelay);
		},false);

		document.querySelector('#logout').addEventListener('click', function() {
			
			var extFrom =  localStorage.getItem('user');
		    socket.send({ extFrom: extFrom, action: "logout" });
		    localStorage.removeItem('user');
			localStorage.removeItem('password');
		    console.log("sended disconnection request for " + extFrom);
		    console.log('user = ' + localStorage.getItem('user'));
			console.log('password = ' + localStorage.getItem('password'));
			
			$('#login_div').slideDown(slideDelay);
			$('#logout').slideUp(slideDelay);
			$('#dialout_div').slideUp(slideDelay);
			$('#address').slideUp(slideDelay);
			
		},false);
		
		
		
		
		document.querySelector('#hangup').addEventListener('click', function() {
			
			var extFrom = localStorage.getItem('user');
			socket.send({ extFrom: extFrom, action: "hangup" });
			console.log("Hangup request has been sent to server");
		},false);
		
		document.querySelector('#waiting').addEventListener('click', function() {
			console.log("to implement");
		},false);
		
		
		document.querySelector('#redirect').addEventListener('click', function() {
	
			var extFrom = localStorage.getItem('user');
			
			var redirectTo = $('#redirect_to').val();
			var redirectFrom = '';
			
			// check if the current call has been originated from me
			if(callFromExt==localStorage.getItem('user')){
				redirectFrom = callToExt;
			}
			// in this case the call is in input
			else{
				redirectFrom = callFromExt;
			}
			socket.send({extFrom: extFrom, redirectFrom: redirectFrom, redirectTo: redirectTo, action: 'redirect'});
			console.log("Redirect request from " + redirectFrom + " to " + redirectTo + " has been sent to server");
			
			callFromExt = '';
   			callToExt = '';
   			
   			$('#redirect').attr('enabled',false);
   			
		},false);
		
		
		// live search of phonebook contacts
		$(document).ready(function() {
			$("#searchbox").keyup(function(){
				var extFrom = localStorage.getItem('user');
				var namex = $("#searchbox").val();
				if(namex.length>=2){
					socket.send({extFrom: extFrom, namex: namex, action: 'search_contact_phonebook'});
					console.log('request to search contact in phonebook has been sent to server');
				}
			});
		});


		// This is function is for clicck to call on result of searching contacts on phonebook
		callExt = function(extToCall){
		
			var extFrom = localStorage.getItem('user');
			
    		if(extFrom==extToCall){
	    		$('#info_calling').slideDown(slideDelay);
    			document.getElementById('info_calling').innerHTML = 'Attention: you trying to call yourself !';
    			return;
    		}
		    socket.send({ extToCall: extToCall, extFrom: extFrom, action: "call_out_from_client" });
		    console.log("sended call request from " + extFrom + " -> to " + extToCall);
		    document.getElementById('info_calling').innerText = 'Calling...';
		    document.getElementById('call').value = 'Calling...';
		    document.getElementById('call').disabled = 'true';
		    $('#info_calling').slideDown(slideDelay);
		    $('#buttoncall').slideDown(slideDelay);
		    $('#logged_in_div').slideUp(slideDelay);
			$('#address').slideUp(slideDelay, function(){
				$('#searchContacts').empty();
	      		$('#searchbox').val('');
			});	
		}

		$(function(){
			var nome = ["alessandro", "andrea", "giacomo"];
			$('#tags').autocomplete({source: nome});
		});

    </script> 
    
    
    
  </body>
</html>
