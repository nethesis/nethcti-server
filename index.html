<!doctype html>
<html>
  <head>
    <title>CTI Nethesis 0.1</title>
    <script src="/json.js"></script> <!-- for ie -->
    <script src="/lib/socket.io-client/socket.io.js"></script>
    <script src="jquery-1.5.1.js"></script>

  </head>
  <body>

    <script>
    	var notificationTimeout = 5000;
    	var outcall = false;

	    function normalDesktopNotification(obj){
	        
        	//var el = document.createElement('p');
	        //el.innerHTML = '<b>' + esc(obj.clientSessionId) + ':</b> ' + esc(obj.respMessage);
    
    	    if (window.webkitNotifications) { //enable notification if supported
	            notification = window.webkitNotifications.createNotification("",esc(obj.clientSessionId),esc(obj.respMessage));
	            notification.ondisplay = function() { console.log("Display notification"); };
	            notification.onclose = function() { console.log("Close notification"); };
	            notification.onclick = function() { 
	            	window.focus(); 
	            	this.cancel(); 
	            };
	            notification.show();
    	        
	            /*
	            setTimeout(function(){
					notification.cancel();
				}, notificationTimeout);
				*/
	      	}
	    }
      
      
      	
      	function htmlDesktopNotification(socket, respMessage){
            	
    		var host = socket.host;
    		var port = socket.options["port"];
    	
        	if (window.webkitNotifications) { //enable notification if supported
			
				var reqUrl = "./getNotificationCalling.html?server=" + host + "&port=" + port + "&from=" + respMessage.from + "&to=" + respMessage.to + "&respMessage=" + respMessage.respMessage;
            	notification = window.webkitNotifications.createHTMLNotification(reqUrl);
	            notification.ondisplay = function() { console.log("Display notification"); };
	            notification.onclose = function() { console.log("Close notification"); };
	            notification.show(); // note the show()
            
	            /*
            	setTimeout(function(){
					notification.cancel();
				}, notificationTimeout);
				*/
        	}
      	}
      

      	function send(val){
        	var val = document.getElementById('text').value;
	        socket.send(val);
	        normalDesktopNotification({ message: ['you', val] });
	        document.getElementById('text').value = '';
	    }
      

      	function esc(msg){
        	return msg.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      	};
      
  
    
      	var socket = new io.Socket(null, {port: 8080, rememberTransport: false});
      	socket.connect();
      	socket.on('message', function(obj){
      		console.debug("Received msg: ");
	      	console.log(obj);
      	
      		if(obj.typeMessage=="dialing"){
	      		console.log("dialing: HTML notification");
	      		htmlDesktopNotification(socket, obj);
	      		
      			document.getElementById('call_out_div').style.display = 'none';
      			document.getElementById('buttoncall').style.display = 'block';
	      		document.getElementById('info_calling').innerText = 'Call incoming from ' + obj.from;
	      		
	      	}
      		else {
		      	console.log("normal notification");
		      	normalDesktopNotification(obj);
		    }
	    
	    	//new--------------------------------------------------
	    	if(obj.typeMessage=="callconnected"){
	      		console.log(obj.respMessage);
	      		document.getElementById('info_calling').innerText = obj.respMessage;
	      		document.getElementById('call').value = 'Calling...';
			    document.getElementById('call').disabled = 'true';
	      	}
	      	if(obj.typeMessage=="hangup"){
	      		console.log(obj.respMessage);
	      		document.getElementById('info_calling').innerText = obj.respMessage;
	      		
	      		document.getElementById('call_out_div').style.display = 'block';
	      		document.getElementById('buttoncall').style.display = 'none';
	      		document.getElementById('call').value = 'Call';
	      		document.getElementById('call').disabled = false;
	      	}
	      	if(obj.typeMessage=="search_contacts_results"){
	      		var results = obj.results;
	      		console.log(obj.respMessage + " and the results are:");
	      		console.log(results);
	      		
	      		console.log("uuuuuuu = " + $('#searchContactsResults'));
	      		if($('#searchContactsResults')!=undefined){
	      			$('#searchContactsResults').remove();
	      		}
	      		
	      		var htmlResults = "<div id='searchContactsResults'>";

	      		for(var i=0; i<results.length; i++){
	      			var el = results[i];
	      			for(key in el){
		      			htmlResults += key + ':  <b>' + el[key] + '</b><br/>'
		      		}
		      		htmlResults += '<br/>'
	      		}
	      		htmlResults += '<div/>';
	      		
	      		$('#searchContacts').append(htmlResults);
	      	}
	      	
	    	//new--------------------------------------------------
	    
	    	if(obj.typeMessage=='ack_login'){
		    	var extFrom =  document.querySelector('#ext').value;
			    var secret =  document.querySelector('#secret').value;
			    if(localStorage.getItem('user')==null){
				    localStorage.setItem('user', extFrom);
				    localStorage.setItem('password', secret);
				}
			    console.log('user = ' + localStorage.getItem('user'));
			    console.log('password = ' + localStorage.getItem('password'));
			    
			   	document.getElementById('login_div').style.display = 'none';
			   	document.getElementById('logged_in_div').style.display = 'block';
			   	document.getElementById('str_logged_in').innerHTML = 'Logged in as ' + localStorage.getItem('user');
			   	document.getElementById('logout').style.display = 'block';
			   	document.getElementById('dialout_div').style.display = 'block';
			    
		    }
	   });
      
   


		if (window.webkitNotifications) {
			console.log("Notifications are supported!");
		}
		else {
			console.log("Notifications are not supported for this Browser/OS version yet.");
		}

    </script>
    
    <h2>CTI Nethesis</h2>
    <div style='font-size: 80%; margin: 20px; '>
      <p>Click on "Enable notifications" only the first time you access this page.</p>
      <input type='button' id='enable' value='Enable notifications'/>    
    </div>
    <!--
    <div id="chat"><p>Click "Login" to start.</p></div>
    <form id="form" onsubmit="send(); return false">
      <input type="text" autocomplete="off" id="text"><input type="submit" value="Send">
    </form>
    -->
    <hr/>
    <div id='logged_in_div'>
    	<h5 id='str_logged_in'>Not logged in</h5>
    	<input type='button' id='logout' value='Logout' style='display:none'/>
    </div>
    <div id='login_div'>
    	<hr/>
	    <h3>Login:</h3>
    	<label for='ext' >Extension:</label><input type='text' name='ext' id='ext' value='500'/>
	    <label for='secret' >Secret:</label><input type='text' name='secret' id='secret' value='500'/>      
	    <input type='button' id='login' value='Login'/>   
	</div>
    <br/>
    
    <div id='dialout_div' style='display:block'>
		<hr/><br/>
		<h3>Dial panel</h3>
		<div id='call_out_div'>
			<label for='extToCall' >Call to:    </label><input type='text' name='extToCall' id='extToCall' value='501'/>      
		
			<input type='button' id='call' value='Call'/>
		</div>
		<br/>
		<label id='info_calling'></label>
		<br/><br/>
		<div id='buttoncall' style='display:none'>
			<input type='button' id='hangup' value='Hangup'/>
			<input type='button' id='transfer' value='Transfer' disabled='true'/>
			<input type='button' id='waiting' value='Waiting' disabled='true'/>
		</div>
		<br/>
	</div>
	
	<!--
	<div id='addressbook'>
		<br/><hr/>
		<h3>Address book</h3>
		<input type="button" id="button_addressbook" value="Show"/>
		<div id='addresses' style='display:none'>
			
		</div>
	</div>
	<br/>
	-->
	
	<div id="form">
		<br/><hr/>
		<h3>Address book</h3>	
		<label>Search:  </label><input type="text" id="searchbox" name="searchbox" value='alessandro'/>
		<div id="searchContacts">
			<a class="button" id="submitbutton" href="#"><span id="buttontext">Search</span></a>
		</div> 
	</div>
	<div id="resultsContainer"></div>
	
    
    <script>
    
    	// if the user and password are set, then it do the login action
		if(localStorage.getItem('user')!=null){
			var extFrom = localStorage.getItem('user');
	    	var secret = localStorage.getItem('password');
			socket.send({ extFrom: extFrom, secret: secret, action: "login" });
			console.log("sended login request from: " + extFrom);
		}
    	
    </script>
    
    
    
   <!--
    <style>
      #chat { height: 300px; overflow: auto; width: 800px; border: 1px solid #eee; font: 13px Helvetica, Arial; }
      #chat p { padding: 8px; margin: 0; }
      #chat p:nth-child(odd) { background: #F6F6F6; }
      #form { width: 782px; background: #333; padding: 5px 10px; display: none; }
      #form input[type=text] { width: 700px; padding: 5px; background: #fff; border: 1px solid #fff; }
      #form input[type=submit] { cursor: pointer; background: #999; border: none; padding: 6px 8px; -moz-border-radius: 8px; -webkit-border-radius: 8px; margin-left: 5px; text-shadow: 0 1px 0 #fff; }
      #form input[type=submit]:hover { background: #A2A2A2; }
      #form input[type=submit]:active { position: relative; top: 2px; }
    </style>
   -->
   
   
   	<script>
   	
   		
   
		document.querySelector('#enable').addEventListener('click', function() {
			if (window.webkitNotifications.checkPermission() == 0) { // 0 is PERMISSION_ALLOWED
		    	// function defined in step 2
			    console.log("Notification allowed");
			} else {
			    console.log("Notification NOT allowed");
			    window.webkitNotifications.requestPermission();
			}
		},false);



		document.querySelector('#login').addEventListener('click', function() {
  			if(localStorage.getItem('user')!=null){
				console.log('Sorry, but you are already logged in !');
  				return;
		  	}
			var extFrom =  document.querySelector('#ext').value;
		    var secret =  document.querySelector('#secret').value;
			socket.send({ extFrom: extFrom, secret: secret, action: "login" });
			console.log("sended login request from: " + extFrom);
		},false);

		document.querySelector('#call').addEventListener('click', function() {

		    var extFrom = localStorage.getItem('user');
    		var extToCall =  document.querySelector('#extToCall').value;
    		if(extFrom==extToCall){
    			document.getElementById('info_calling').style.display = 'yes';
    			document.getElementById('info_calling').innerHTML = 'Attention: you trying to call yourself !';
    			return;
    		}
		    socket.send({ extToCall: extToCall, extFrom: extFrom, action: "call_out_from_client" });
		    console.log("sended call request from " + extFrom + " -> to " + extToCall);
		    document.getElementById('info_calling').style.display = 'block';
		    document.getElementById('info_calling').innerText = 'Calling...';
		    document.getElementById('call').value = 'Calling...';
		    document.getElementById('call').disabled = 'true';
		    document.getElementById('buttoncall').style.display = 'block';
		},false);

		document.querySelector('#logout').addEventListener('click', function() {
			
			var extFrom =  localStorage.getItem('user');
		    socket.send({ extFrom: extFrom, action: "logout" });
		    localStorage.removeItem('user');
			localStorage.removeItem('password');
		    console.log("sended disconnection request for " + extFrom);
		    console.log('user = ' + localStorage.getItem('user'));
			console.log('password = ' + localStorage.getItem('password'));
			
			document.getElementById('str_logged_in').innerHTML = 'Logged off';
			document.getElementById('login_div').style.display = 'block';
			document.getElementById('logout').style.display = 'none';
			document.getElementById('dialout_div').style.display = 'none';
			
		},false);
		
		
		/*
		document.querySelector('#button_addressbook').addEventListener('click', function(){

			if(document.getElementById('addresses').style.display=='none'){
				document.getElementById('button_addressbook').value = 'Hide';
				document.getElementById('addresses').style.display = 'block';
				
				// request addresses to server
				var extFrom = localStorage.getItem('user');
				socket.send({ extFrom: extFrom, action: "addresses" });
				console.log("request for addresses has been sent to server");
				
				// check if the answer isn't undefined
				
				
				// set the element of the html page to answer recevied from the server


			}
			else{
				document.getElementById('button_addressbook').value = 'Show';
				document.getElementById('addresses').style.display = 'none';
			}
			
		}, false);
		*/
		
		
		document.querySelector('#hangup').addEventListener('click', function() {
			
			var extFrom = localStorage.getItem('user');
			socket.send({ extFrom: extFrom, action: "hangup" });
			console.log("Hangup request has been sent to server");
		},false);
		
		document.querySelector('#waiting').addEventListener('click', function() {
			console.log("to implement");
		},false);
		
		
		document.querySelector('#transfer').addEventListener('click', function() {
			console.log("to implement");
		},false);
		
		
		
		$(document).ready(function() {
			
			console.log("document ready");
			
			$("#searchbox").keyup(function(){
				
				console.log("keyup");				

				var extFrom = localStorage.getItem('user');
				var namex = $("#searchbox").val();
				console.log("LENGHTTTUU");
				if(namex.length>=2 && (namex.length%2)==0){
					console.log('namex = ' + namex);
					socket.send({extFrom: extFrom, namex: namex, action: 'search_contact_phonebook'});
					console.log('request to search contact in phonebook has been sent to server');
				}
 
 				/*
				$.get("search.php",{query: $("#searchbox").val(), type: "count"}, function(data){
 
					$("#buttontext").html(data + " Results Available");
 
				});
				*/
				
				
			});
 /*
			$("#searchbox").keyup(function(event){
 
				if(event.keyCode == "13")
				{
					getResults();
				}
	 
			});
 
			$("#submitbutton").click(function(){
 
				getResults();
 
			});
 
			function getResults()
			{
		 
				$.get("search.php",{query: $("#searchbox").val(), type: "results"}, function(data){
 
					$("#resultsContainer").html(data);
					$("#resultsContainer").show("blind");
				});
			
			}
 			*/
		});

    </script> 
    
    
  </body>
</html>
