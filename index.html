<!doctype html>
<html>
  <head>
    <title>CTI Nethesis 0.1</title>
    <script src="/json.js"></script> <!-- for ie -->
    <script src="/lib/socket.io-client/socket.io.js"></script>
    <script src="jquery-1.5.1.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.js'></script>

  </head>
  <body onload='window.webkitNotifications.requestPermission();'>

	<script>
		callFromExt = '';
		callToExt = '';
	</script>

    <script>
    	var notificationTimeout = 5000;
    	var slideDelay = 200;


	    function normalDesktopNotification(obj){
    
    	    if (window.webkitNotifications) { //enable notification if supported
	            notification = window.webkitNotifications.createNotification("",esc(obj.clientSessionId),esc(obj.respMessage));
	            notification.ondisplay = function() { console.log("Display notification"); };
	            notification.onclose = function() { console.log("Close notification"); };
	            notification.onclick = function() { 
	            	window.focus(); 
	            	this.cancel(); 
	            };
	            notification.show();
    	        
	            /*
	            setTimeout(function(){
					notification.cancel();
				}, notificationTimeout);
				*/
	      	}
	    }
      
      
      	
      	function htmlDesktopNotification(socket, respMessage){
            	
    		var host = socket.host;
    		var port = socket.options["port"];
    	
        	if (window.webkitNotifications) { //enable notification if supported
			
				var reqUrl = "./getNotificationCalling.html?server=" + host + "&port=" + port + "&from=" + respMessage.from + "&to=" + respMessage.to + "&respMessage=" + respMessage.respMessage;
            	notification = window.webkitNotifications.createHTMLNotification(reqUrl);
	            notification.ondisplay = function() { console.log("Display notification"); };
	            notification.onclose = function() { console.log("Close notification"); };
	            notification.show(); // note the show()
            
	            /*
            	setTimeout(function(){
					notification.cancel();
				}, notificationTimeout);
				*/
        	}
      	}
      

      	function esc(msg){
        	return msg.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      	};
      
  
    
      	var socket = new io.Socket(null, {port: 8080, rememberTransport: false});
      	socket.connect();
      	socket.on('message', function(obj){
      	
      		console.debug("Received message: ");
	      	console.log(obj);
      	
      		if(obj.typeMessage=="dialing"){
	      		
	      	}
      		else if(obj.typeMessage!="search_contacts_results" && obj.typeMessage!="ack_login" && obj.typeMessage!="connected"){
		      	console.log("normal notification");
		      	normalDesktopNotification(obj);
		    }
	    
	    	switch(obj.typeMessage){
				case 'error_login':
					$('info_login').text(obj.respMessage);
				break;
				case 'ack_login':
	    			var extFrom =  document.querySelector('#ext').value;
				    var secret =  document.querySelector('#secret').value;
				    if(localStorage.getItem('user')==null){
					    localStorage.setItem('user', extFrom);
					    localStorage.setItem('password', secret);
					}
					console.log('sono in ack login');
				    $('#login_div').slideUp(slideDelay);
				    $('#info_notification').slideUp(0);
				    console.log('B');
				    $('#logout_div').slideDown(slideDelay);
				    console.log('C');
				    document.getElementById('logout').value = 'Logout ' + extFrom;
				    $('#dialout_div').slideDown(slideDelay);
				    $('#address').slideDown(slideDelay);
				    console.log('D');
				    callFromExt = '';
	      			callToExt = '';
	    		break;
	    		case 'error_call':
	    			console.log(obj.respMessage);
		      		document.getElementById('info_calling').innerText = obj.respMessage;
		      		$('#record').attr('disabled',false);
	    		break;
	    		case 'dialing':
		      		htmlDesktopNotification(socket, obj);
					$('#call_out_div').slideUp(slideDelay);
					$('#buttoncall').slideDown(slideDelay);
					$('#login_div').slideUp(slideDelay);
					$('#address').slideUp(slideDelay);
		      		document.getElementById('info_calling').innerText = 'Call incoming from ' + obj.from;
		      		callFromExt = obj.from;
		      		callToExt = localStorage.getItem('user');
	    		break;
	    		case 'callconnected':
	    			console.log(obj.respMessage);
		      		document.getElementById('info_calling').innerText = obj.respMessage;
		      		document.getElementById('call').value = 'Calling...';
				    document.getElementById('call').disabled = 'true';
				    document.getElementById('redirect').disabled = false;
				    $('#record').attr('disabled',false);
	    		break;
	    		case 'hangup':
	    			console.log(obj.respMessage);
		      		document.getElementById('info_calling').innerText = obj.respMessage;      		
		      		$('#call_out_div').slideDown(slideDelay);
		      		$('#buttoncall').slideUp(slideDelay);
		      		$('#login_div').slideDown(slideDelay);
		      		$('#address').slideDown(slideDelay);
		      		$('#record').attr('disabled', true);
		      		document.getElementById('call').value = 'Call';
		      		document.getElementById('call').disabled = false;
		      		callFromExt = '';
	      			callToExt = '';
	    		break;
	    		case 'error_redirect':
	    			console.log(obj.respMessage);
		      		document.getElementById('info_calling').innerText = obj.respMessage;
	    		break;
	    		case 'ack_redirect':
	    			console.log(obj.respMessage);
		      		document.getElementById('info_calling').innerText = obj.respMessage;
	    		break;
	    		case 'error_search_contacts':
		    		console.log(obj.respMessage);
	    			$('#searchContacts').append(obj.respMessage);
	    		break;
	    		case 'search_contacts_results':
	    			var results = obj.results;
	      			if($('#searchContactsResults')!=undefined){
		      			$('#searchContactsResults').remove();
		      		}
	      		
		      		var htmlResults = "<div id='searchContactsResults'>";

		      		for(var i=0; i<results.length; i++){
		      			var el = results[i];
		      			for(key in el){
		      			
		      				if(key=='workphone'){
		      					console.log("uguale workphone");
		      					var call = "callExt(" + el[key] + ");";
		      					htmlResults += key + ':  <b>' + el[key] + '  </b><input type="button" onclick=' + call + ' value="Call"/><br/>';
		      				}
		      				else{      				
				      			htmlResults += key + ':  <b>' + el[key] + '</b><br/>';
				      		}
			      		}
			      		htmlResults += '<br/>';
		      		}
		      		htmlResults += '<div/>';
		      		$('#searchContacts').append(htmlResults);
	    		break;
	    		case 'error_record':
	    			console.log(obj.respMessage);
		      		document.getElementById('info_calling').innerText = obj.respMessage;
	    		break;
	    		case 'ack_record':
	    			$('#record').val('Stop recording...');
	    			console.log(obj.respMessage);
	    		break;
	    		case 'ack_stoprecord':
	    			$('#record').val('Record');
	    			console.log(obj.respMessage);
	    		break;
	    		default:
	    			console.log("default operation");
	    		break;    		
	    	}
	   });
      
   
		
	
		


    </script>
    
    
    
	<div id='info_notification' style='display:none'>
      	<p>Click on "Enable notifications" only the first time you access this page.</p>
      	<input type='button' id='enable' value='Enable notifications'/>    
    </div>
    
    <div id='logout_div' style='display:none'>
    	<input type='button' id='logout' value='Logout'/>
    </div>
    
    <div id='login_div'>
	    <h3>Login:</h3>
    	<label for='ext' >Extension:</label><input type='text' name='ext' id='ext' value='500'/>
	    <label for='secret' >Secret:</label><input type='text' name='secret' id='secret' value='500'/>      
	    <input type='button' id='login' value='Login'/>   
	    <label id='info_login'></label>
	    <br/>
	</div>
    
    
    <div id='dialout_div' style='display:none'>
		<hr/><br/>
		<h3>Dial panel</h3>
		<div id='call_out_div'>
			<label for='extToCall' >Call to:    </label><input type='text' name='extToCall' id='extToCall' value='501'/>      
		
			<input type='button' id='call' value='Call'/>
			<br/>
		</div>
		<label id='info_calling'></label>
		<br/><br/>
		<div id='buttoncall' style='display:none'>
			<input type='button' id='hangup' value='Hangup'/>
			<input type='button' id='waiting' value='Waiting' disabled='true'/>
			<input type='button' id='record' value='Record' disabled='true'/><br/>
			<label>Redirect to: </label><input type='text' id='redirect_to'/><input type='button' id='redirect' value='Redirect' disabled='true'/>
			
		</div>
		<br/>
	</div>
	
	
	<div id="address" style='display:none'>
		<br/><hr/>
		<h3>Address book</h3>	
		<label>Search:  </label><input type="text" id="searchcontact" name="searchcontact"/>
		<br/><br/>
		<div id="searchContacts">
		</div> 
	</div>
	<div id="resultsContainer"></div>
	
    <script>
    
		//OK
    	$(function(){
    	
    		if (window.webkitNotifications) {
				console.log("Notifications are supported!");
			}
			else {
				var msg = "Notifications are not supported for this Browser/OS version yet.";
				console.log(msg);
				return;
			}
    	
    	
    		if (window.webkitNotifications.checkPermission() == 0) { // 0 is PERMISSION_ALLOWED
		    	// function defined in step 2
			    console.log("Notification allowed");
			} else {
				console.log("Notification NOT allowed");
				$('#info_notification').slideDown(slideDelay);
			}
			
			
			// if the user and password are set, then it do the login action
			if(localStorage.getItem('user')!=null){
				var extFrom = localStorage.getItem('user');
		    	var secret = localStorage.getItem('password');
				socket.send({ extFrom: extFrom, secret: secret, action: "login" });
				console.log("sended login request from: " + extFrom);
			}
		});
    
    	//OK
		$('#enable').click(function() {
			window.webkitNotifications.requestPermission(function(){
				$('#info_notification').slideUp(slideDelay);
			});	
		});


		//OK
		$('#login').click(function(){
			if(localStorage.getItem('user')!=null){
				console.log('Sorry, but you are already logged in !');
  				return;
		  	}
			var extFrom =  document.querySelector('#ext').value;
		    var secret =  document.querySelector('#secret').value;
			socket.send({ extFrom: extFrom, secret: secret, action: "login" });
			console.log("sended login request for [" + extFrom + "]");
		});

		
		//OK
		$('#call').click(function(){

		    var extFrom = localStorage.getItem('user');
    		var extToCall =  document.querySelector('#extToCall').value;
    		
			callFromExt = extFrom;
			callToExt = extToCall;
			
			console.log('callFromExt = ' + callFromExt);
    		
    		if(extFrom==extToCall){
    		
    			$('#info_calling').slideDown(slideDelay);
    			document.getElementById('info_calling').innerHTML = 'Attention: you trying to call yourself !';
    			return;
    		}
		    socket.send({ extToCall: extToCall, extFrom: extFrom, action: "call_out_from_client" });
		    console.log("sended call request from " + extFrom + " -> to " + extToCall);

			$('#info_calling').slideDown(slideDelay);
		    document.getElementById('info_calling').innerText = 'Calling...';
		    document.getElementById('call').value = 'Calling...';
		    document.getElementById('call').disabled = 'true';
		    $('#buttoncall').slideDown(slideDelay);
		    $('#login_div').slideUp(slideDelay);
		    $('#address').slideUp(slideDelay);
		});
		
		//OK
		$('#hangup').click(function(){
			
			var extFrom = localStorage.getItem('user');
			socket.send({ extFrom: extFrom, action: "hangup" });
			console.log("Hangup request has been sent to server");
		});
		
		//OK
		$('#logout').click(function(){
			
			var extFrom =  localStorage.getItem('user');
		    socket.send({ extFrom: extFrom, action: "logout" });
		    localStorage.removeItem('user');
			localStorage.removeItem('password');
		    console.log("sended disconnection request for " + extFrom);
		    console.log('user = ' + localStorage.getItem('user'));
			console.log('password = ' + localStorage.getItem('password'));
			
			$('#login_div').slideDown(slideDelay);
			$('#logout_div').slideUp(slideDelay);
			$('#dialout_div').slideUp(slideDelay);
			$('#address').slideUp(slideDelay);
			
		});
		//OK
		$('#waiting').click(function(){
			console.log("to implement");
		},false);
		
		//OK
		$('#redirect').click(function(){
	
			var extFrom = localStorage.getItem('user');
			
			var redirectTo = $('#redirect_to').val();
			var redirectFrom = '';
			
			// check if the current call has been originated from me
			if(callFromExt==localStorage.getItem('user')){
				redirectFrom = callToExt;
			}
			// in this case the call is in input
			else{
				redirectFrom = callFromExt;
			}
			socket.send({extFrom: extFrom, redirectFrom: redirectFrom, redirectTo: redirectTo, action: 'redirect'});
			console.log("Redirect request from " + redirectFrom + " to " + redirectTo + " has been sent to server");
			
			callFromExt = '';
   			callToExt = '';
   			
   			$('#redirect').attr('enabled',false);
   			
		},false);
		
		//OK
		// live search of phonebook contacts
		$(document).ready(function() {
			$("#searchcontact").keyup(function(){
				var extFrom = localStorage.getItem('user');
				var namex = $("#searchcontact").val();
				if(namex.length>=2){
					socket.send({extFrom: extFrom, namex: namex, action: 'search_contact_phonebook'});
					console.log('request to search contact in phonebook has been sent to server');
				}
			});
		});
		//OK
		$('#record').click(function(){
		
			var buttonValue = $('#record').val();
			var extFrom = localStorage.getItem('user');
			
			if(buttonValue == 'Record'){
			    socket.send({ extFrom: extFrom, callFromExt: callFromExt, callToExt: callToExt, action: 'record' });
			    console.log("sended record request for me [" + extFrom + "]");
			}
			else{ // stop recording
				socket.send({ extFrom: extFrom, action: 'stoprecord' });
			    console.log("sended stop record request for me [" + extFrom + "]");
			}	
		});


		// This is function is for clicck to call on result of searching contacts on phonebook
		callExt = function(extToCall){
		
			var extFrom = localStorage.getItem('user');
			
    		if(extFrom==extToCall){
	    		$('#info_calling').slideDown(slideDelay);
    			document.getElementById('info_calling').innerHTML = 'Attention: you trying to call yourself !';
    			return;
    		}
		    socket.send({ extToCall: extToCall, extFrom: extFrom, action: "call_out_from_client" });
		    console.log("sended call request from " + extFrom + " -> to " + extToCall);
		    document.getElementById('info_calling').innerText = 'Calling...';
		    document.getElementById('call').value = 'Calling...';
		    document.getElementById('call').disabled = 'true';
		    $('#info_calling').slideDown(slideDelay);
		    $('#buttoncall').slideDown(slideDelay);
		    $('#login_div').slideUp(slideDelay);
			$('#address').slideUp(slideDelay, function(){
				$('#searchContacts').empty();
	      		$('#searchcontact').val('');
			});	
		}

		
    </script> 
    
    
    
  </body>
</html>
