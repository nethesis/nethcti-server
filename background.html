<html>
<head>
	<script src="/json.js"></script> 
    <script src="/lib/socket.io-client/socket.io.js"></script>
    <script src="jquery-1.5.1.js"></script>
</head>
<body>
	
	<script>
		callFromExt = '';
		callToExt = '';
		parent = '';
		notificationTimeout = 5000;
	</script>
	
	<script>
	
		function htmlDesktopNotification(socket, respMessage){
            	
    		var host = socket.host;
    		var port = socket.options["port"];
    	
        	if (window.webkitNotifications) { //enable notification if supported
			
				var reqUrl = "./getNotificationCalling.html?server=" + host + "&port=" + port + "&from=" + respMessage.from + "&to=" + respMessage.to + "&respMessage=" + respMessage.respMessage;
            	notification = window.webkitNotifications.createHTMLNotification(reqUrl);
	            notification.ondisplay = function() { console.log("Display notification"); };
	            notification.onclose = function() { console.log("Close notification"); };
	            notification.show(); // note the show()
            
	            /*
            	setTimeout(function(){
					notification.cancel();
				}, notificationTimeout);
				*/
        	}
      	}
		
	</script>

	<script>
	
		var socket = new io.Socket(null, {port: 8080, rememberTransport: false});
      	socket.connect();
      	socket.on('message', function(obj){
      	
      		console.debug("Received message: ");
	      	console.log(obj);
        
	    	switch(obj.typeMessage){
	    		case 'connected':
	    			console.log('connected to server');
	    		break;
				case 'error_login':
					console.log('received error login');
					opener.updateInfoLogin(obj);
				break;
				case 'ack_login':
					console.log('received ack login');
				    if(localStorage.getItem('user')==null || localStorage.getItem('user')=='undefined'){
					    localStorage.setItem('user', obj.ext);
					    localStorage.setItem('password', obj.secret);
					}
					opener.updateAckLoginGui();
				    callFromExt = '';
	      			callToExt = '';
	    		break;
	    		case 'error_call':
	    			console.log('received error call');
	    			console.log(obj.respMessage);
	    			opener.updateErrorCalling(obj);
	    		break;
	    		case 'dialing':
	    			console.log('received dialing event');
		      		htmlDesktopNotification(socket, obj);
		      		opener.updateCallingGui(obj);
		      		callFromExt = obj.from;
		      		callToExt = localStorage.getItem('user');
	    		break;
	    		case 'callconnected':
	    			console.log('received call connected event');
	    			console.log(obj.respMessage);
	    			opener.updateCallConnectedGui(obj);
	    		break;
	    		case 'hangup':
	    			console.log('received hangup event');
	    			console.log(obj.respMessage);
	    			opener.updateHangupGui(obj);
		      		callFromExt = '';
	      			callToExt = '';
	    		break;
	    		case 'error_redirect':
	    			console.log('received error redirect');
	    			console.log(obj.respMessage);
	    			opener.updateErrorRedirectGui(obj);
	    		break;
	    		case 'ack_redirect':
		    		console.log('received ack redirect');
	    			console.log(obj.respMessage);
	    			opener.updateAckRedirectGui(obj);
	    		break;
	    		case 'error_search_contacts':
	    			console.log('received error serach contacts');
		    		console.log(obj.respMessage);
		    		opener.updateSearchContactsGui(obj);
	    		break;
	    		case 'search_contacts_results':
	    			console.log('received search contacts results');
	    			opener.updateSearchContactsResultsGui(obj);
	    		break;
	    		case 'error_record':
	    			console.log('received error record');
	    			console.log(obj.respMessage);
	    			opener.updateErrorRecordGui(obj);
	    		break;
	    		case 'ack_record':
	    			console.log('received ack record');
	    			console.log(obj.respMessage);
	    			opener.updateAckRecordGui(obj);
	    		break;
	    		case 'ack_stoprecord':
	    			console.log('received ack stop record');
	    			console.log(obj.respMessage);
	    			opener.updateAckStopRecordGui(obj);
	    		break;
	    		default:
	    			console.log("default operation");
	    		break;    		
	    	}
	   	});
	</script>
	
	<script>
		
    	$(function(){
    	
    		opener = window.opener;
    	
    		// if the user and password are set, then it do the login action
    		var user = localStorage.getItem('user');
			if(user!=null && user!='undefined'){
				var extFrom = localStorage.getItem('user');
		    	var secret = localStorage.getItem('password');
				socket.send({ extFrom: extFrom, secret: secret, action: "login" });
				console.log("sended login request from: " + extFrom);
			}
		
		});
		
		function doLogin(objLogin){
			console.log(objLogin);
			socket.send(objLogin);
			console.log("sended login request for [" + objLogin.extFrom + "]");
		}
		function doCall(objCall){
			console.log(objCall);
			socket.send(objCall);
			console.log("sended call request from " + objCall.extFrom + " -> to " + objCall.extToCall);
		}
		function doHangup(objHangup){
			socket.send(objHangup);
			console.log("Hangup request has been sent to server");
		}
		function doLogout(objLogout){
			socket.send(objLogout);
			localStorage.removeItem('user');
			localStorage.removeItem('password');
		    console.log("sended disconnection request for " + objLogout.extFrom);
		    console.log('user = ' + localStorage.getItem('user'));
			console.log('password = ' + localStorage.getItem('password'));
		}
		function doRedirect(objRedirect){
			socket.send(objRedirect);
			console.log("Redirect request from " + objRedirect.redirectFrom + " to " + objRedirect.redirectTo + " has been sent to server");
			
			callFromExt = '';
   			callToExt = '';
		}
		function doSearchContact(objSearchContact){
			socket.send(objSearchContact);
			console.log('request to search contact in phonebook has been sent to server');
		}
		function doStartRecord(objStartRecord){
			objStartRecord.callFromExt = callFromExt;
			objStartRecord.callToExt = callToExt;
			socket.send(objStartRecord);
			console.log("sended record request for me [" + objStartRecord.extFrom + "]");
		}
		function doStopRecord(objStopRecord){
			socket.send(objStopRecord);
			console.log("sended stop record request for me [" + objStopRecord.extFrom + "]");
		}
		
		
	</script>
</body>
</html>
